import{addNotification as e}from"./notification.js";document.addEventListener("DOMContentLoaded",()=>{let t=io("/game"),s=document.getElementById("visitors"),n=document.getElementById("surrended"),a=document.getElementById("current-player"),r=document.getElementById("timer"),l=document.getElementById("mobile-timer"),i=document.getElementById("timer-progress-circle"),o=document.getElementById("mobile-timer-progress"),d=document.getElementById("selected-char"),c=document.getElementById("btn-surrend"),u=document.getElementById("players"),m=document.getElementById("play-mode-switch"),$=document.getElementById("play-mode-label");document.getElementById("board-container");let p=document.getElementById("board-viewport"),g=document.getElementById("board-wrapper");document.getElementById("game-board");let f=document.getElementById("zoom-slider"),y=document.getElementById("zoom-percentage"),v=document.getElementById("zoom-in"),h=document.getElementById("zoom-out"),b=document.getElementById("reset-zoom"),_=document.getElementById("pan-indicator"),E=null,L=0,x=0,B=!0,I=100,T=!1,w=0,C=0,k=0,A=0;function S(){f.addEventListener("input",e=>{I=Number.parseInt(e.target.value),z()}),v.addEventListener("click",()=>{I=Math.min(200,I+10),f.value=I,z()}),h.addEventListener("click",()=>{I=Math.max(50,I-10),f.value=I,z()}),b.addEventListener("click",()=>{I=100,f.value=I,z(),p.scrollLeft=0,p.scrollTop=0}),p.addEventListener("wheel",e=>{if(e.ctrlKey||e.metaKey){e.preventDefault();let t=e.deltaY>0?-10:10;I=Math.max(50,Math.min(200,I+t)),f.value=I,z()}}),p.addEventListener("mousedown",N),p.addEventListener("mousemove",Y),p.addEventListener("mouseup",P),p.addEventListener("mouseleave",P),p.addEventListener("touchstart",D,{passive:!1}),p.addEventListener("touchmove",H,{passive:!1}),p.addEventListener("touchend",P),p.addEventListener("mouseenter",()=>{I>100&&(_.style.opacity="1")}),p.addEventListener("mouseleave",()=>{_.style.opacity="0"})}function z(){let e=I/100;g.style.transform=`scale(${e})`,y.textContent=`${I}%`,I>100?_.style.display="block":_.style.display="none",h.disabled=I<=50,v.disabled=I>=200}function N(e){I<=100||(T=!0,p.style.cursor="grabbing",w=e.pageX-p.offsetLeft,C=e.pageY-p.offsetTop,k=p.scrollLeft,A=p.scrollTop,e.preventDefault())}function D(e){if(I<=100||1!==e.touches.length)return;T=!0;let t=e.touches[0];w=t.pageX-p.offsetLeft,C=t.pageY-p.offsetTop,k=p.scrollLeft,A=p.scrollTop}function Y(e){if(!T||I<=100)return;e.preventDefault();let t=e.pageX-p.offsetLeft,s=e.pageY-p.offsetTop,n=(t-w)*2,a=(s-C)*2;p.scrollLeft=k-n,p.scrollTop=A-a}function H(e){if(!T||I<=100||1!==e.touches.length)return;e.preventDefault();let t=e.touches[0],s=t.pageX-p.offsetLeft,n=t.pageY-p.offsetTop,a=(s-w)*2,r=(n-C)*2;p.scrollLeft=k-a,p.scrollTop=A-r}function P(){T=!1,p.style.cursor=I>100?"grab":"default"}function j(e){X(),x=((L=1e3*e)-Date.now())/1e3,E=setInterval(()=>{let e=L-Date.now();M(Math.max(0,e/1e3)),e<=0&&(clearInterval(E),t.emit("timeout"))},100)}function M(e){let t=e.toFixed(1);if(r&&(r.innerText=t),l&&(l.innerText=t),i&&x>0){let s=e/x;i.style.strokeDashoffset=s,s>.5?i.style.stroke="#28a745":s>.25?i.style.stroke="#ffc107":i.style.stroke="#dc3545"}if(o&&x>0){let n=e/x*100;o.style.width=`${n}%`,n>50?o.style.backgroundColor="#28a745":n>25?o.style.backgroundColor="#ffc107":o.style.backgroundColor="#dc3545"}}function X(){E&&clearInterval(E)}function G(e){let t=u.getAttribute("data-current-user");a.innerText=e,e==t?a.classList.add("bg-success"):a.classList.remove("bg-success"),O(e)}function O(e){document.querySelectorAll(".player-score-card").forEach(e=>{e.classList.remove("current-player-highlight")});let t=document.getElementById(`item-${e}`);t&&t.classList.add("current-player-highlight")}function R(e,t){m.disabled=!t,m.checked=e,$.innerHTML=e?`
        <span class="badge bg-success">Playing</span>
        `:`
        <span class="badge bg-secondary">Spectating</span>
        `}function q(e,t){let s=document.getElementById(`status-${e}`);t?(s.classList.add("text-success"),s.classList.remove("text-danger"),s.setAttribute("title","Status: Playing")):(s.classList.add("text-danger"),s.classList.remove("text-success"),s.setAttribute("title","Status: Spectating"))}function F(e,t,s){let n=t;if(n===s)return;let a=setInterval(()=>{n+=1,e.innerText=n,n==s&&clearInterval(a)},500/Math.max(Math.abs(s-t),1))}function K(){let e=0,t=!1;for(let s of u.children){let[n]=s.getElementsByClassName("player-status");if(!(s.classList.contains("text-danger")||n.classList.contains("text-danger"))&&++e>=2){t=!0;break}}return t}function U(e,t){let s=document.createElement("div");s.className="floating-points",s.innerText=`+${t}`;let n=e.getBoundingClientRect();s.style.cssText=`
            position: fixed;
            left: ${n.left}px;
            top: ${n.top}px;
            color: #28a745;
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            z-index: 1000;
            animation: floatUp 2s ease-out forwards;
        `,document.body.appendChild(s),setTimeout(()=>{s.parentNode&&s.remove()},2e3)}function W(){for(let e=0;e<20;e++)setTimeout(()=>{J()},100*e)}function J(){let e=document.createElement("div");e.className="celebration-particle",e.style.cssText=`
            position: fixed;
            width: 10px;
            height: 10px;
            background: ${Q()};
            border-radius: 50%;
            left: ${Math.random()*window.innerWidth}px;
            top: ${window.innerHeight}px;
            pointer-events: none;
            z-index: 1000;
            animation: particleFloat 3s ease-out forwards;
        `,document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.remove()},3e3)}function Q(){let e=["#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#f1c40f"];return e[Math.floor(Math.random()*e.length)]}S(),t.on("connect",()=>{console.log("Connected to game"),e("Connected to game","success")}),t.on("disconnect",()=>{console.log("Disconnected from game"),e("Disconnected from game","danger")}),t.on("self_init",e=>{for(let t in e.cells){let s=e.cells[t],a=document.getElementById(`btn-${t}`);if(["1","2","3","4"].includes(s)){if(a.classList.add("played"),"1"==s){a.textContent="S";continue}if("2"==s){a.textContent="O";continue}a.classList.remove("played"),a.classList.add("cell-scored"),"3"==s?a.textContent="S":"4"==s&&(a.textContent="O")}}if(e.players&&e.scores&&e.players_statuses){let r=e.scores.split(" ");u.innerHTML="",e.players.forEach((t,s)=>{let n=!1,a=!1,l=document.createElement("div");l.className="player-score-card",l.id=`item-${t}`;let i="";t===u.getAttribute("data-current-user")&&(i+=' <span class="badge bg-primary ms-2">You</span>'),t===u.getAttribute("data-host")&&(i+=' <span class="badge bg-success ms-2">Host</span>'),"3"==e.players_statuses[s]?(n=!0,a=!0):"2"==e.players_statuses[s]?(n=!0,a=!1):"1"==e.players_statuses[s]?(n=!1,a=!0):"0"==e.players_statuses[s]&&(n=!1,a=!1),n||l.classList.add("text-danger"),l.innerHTML=`
                <div class="player-info">
                    <span id="status-${t}" class="player-status ${a?"text-success":"text-danger"} fas fa-circle me-2" title="Status: ${a?"Playing":"Spectating"}"></span>
                    <span class="player-name">${t}</span>
                    ${i}
                </div>
                <div class="player-score">
                    <span id="${t}" class="score-number">${r[s]||0}</span>
                    <small class="text-muted">points</small>
                </div>
                `,u.appendChild(l)})}if(void 0!==e.surrenders){let[l,i]=e.surrenders.split("/");n.innerText=`${l} / ${i}`}G(e.current_player),R(e.playing_status,e.surrended_status),console.log("Game initialized with players:",e.players)}),t.on("self_init_timer",e=>{j(e)}),t.on("self_surrend",e=>{m.disabled=!1}),t.on("self_turn_playing_status",e=>{e.success&&void 0!==e.status&&R(e.status,!0)}),t.on("self_refresh_timer",e=>{let[t,s]=e.split(" ");j(Number.parseInt(t)),G(s)}),t.on("user_join",t=>{let s=document.getElementById(`item-${t.username}`);if(s&&(s.classList.remove("text-danger"),e(`${t.username} rejoined the game`,"success")),void 0!==t.surrenders){let[a,r]=t.surrenders.split("/");n.innerText=`${a} / ${r}`}q(t.username,t.playing_status)}),t.on("user_leave",t=>{G(t.current_player);let s=document.getElementById(`item-${t.username}`);if(s&&(s.classList.add("text-danger"),e(`${t.username} left the game`,"warning")),void 0!==t.surrenders){let[a,r]=t.surrenders.split("/");n.innerText=`${a} / ${r}`}}),t.on("user_play",t=>{let s=document.getElementById(`btn-${t.char_index}`);s&&(s.innerText=t.char,s.disabled=!0,s.classList.add("played"),s.style.animation="cellClick 0.4s ease",setTimeout(()=>{s.style.animation=""},400)),t.changed_states&&t.changed_states.length>0&&t.changed_states.forEach((e,t)=>{setTimeout(()=>{let t=document.getElementById(`btn-${e}`);t&&(t.classList.remove("played"),t.classList.add("cell-scored"),t.style.animation="scoreAnimation 0.6s ease",setTimeout(()=>{t.style.animation=""},600))},150*t)});let n=document.getElementById(t.username);if(n){let a=Number.parseInt(n.innerText)||0,r=a+(t.added_score||0);F(n,a,r),t.added_score&&t.added_score>0&&(e(`${t.username} scored ${t.added_score} points!`,"success"),U(n,t.added_score))}t.current_player&&G(t.current_player)}),t.on("user_turn_playing_status",e=>{void 0!==e.username&&void 0!==e.status&&void 0!==e.current_player&&(q(e.username,e.status),G(e.current_player))}),t.on("user_surrend",t=>{if(void 0!==t.surrenders){let[s,a]=t.surrenders.split("/");n.innerText=`${s} / ${a}`,e("A player has surrendered","warning")}}),t.on("user_reset_timer",e=>{j(e)}),t.on("visitor_join",e=>{void 0!=e.visitors&&(s.innerText=e.visitors)}),t.on("visitor_leave",e=>{void 0!=e.visitors&&(s.innerText=e.visitors)}),t.on("game_not_found",t=>{e("Game not found! Redirecting...","danger"),setTimeout(()=>{let e=document.getElementsByClassName("game-section");e.length<1||(window.location.href=e[0].getAttribute("data-join-room-url"))},2e3)}),t.on("game_require_2_players",t=>{e("To play, there must be at least 2 players online and active","danger")}),t.on("game_end",t=>{e("Game ended! Redirecting...","info"),X(),W(),setTimeout(()=>{let e=document.getElementsByClassName("game-section");e.length<1||(window.location.href=e[0].getAttribute("data-thank-you-url"))},5e3)}),window.btnPlayClicked=s=>{if(!K()){e("To play, there must be at least 2 players online and active","danger");return}let n=document.getElementById(`btn-${s}`);if(u.getAttribute("data-current-user")!=a.textContent){e("You aren't the current player","danger");return}if(!n||""!==n.innerText.trim()||n.disabled){e("This cell is already taken!","warning");return}let r=d.value;n.classList.add("playing"),n.style.transform="scale(0.9)",e("Please wait....","primary"),t.emit("play",{char_index:s,char:r}),setTimeout(()=>{n.classList.remove("playing"),n.style.transform=""},300)},m.addEventListener("input",s=>{if(!B){m.disabled=!0,e("Please wait around 10 seconds to switch the play mode","warning");return}t.emit("turn_playing_status"),setTimeout(()=>{B=!1,m.disabled=!0},1),setTimeout(()=>{B=!0,m.disabled=!1,e("Now you can switch it back","info")},1e4)}),c&&c.addEventListener("click",function(){confirm("Are you sure you want to surrender? This action cannot be undone.")&&(t.emit("surrend"),this.disabled=!0,this.innerHTML='<i class="fas fa-flag me-2"></i>Surrendered',this.classList.remove("btn-outline-danger"),this.classList.add("btn-danger"),e("You have surrendered","info"))});let V=a.innerText;V&&O(V)});