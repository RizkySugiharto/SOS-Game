import{addNotification as e}from"./notification.js";document.addEventListener("DOMContentLoaded",()=>{let t=document.getElementById("input-players"),n=document.getElementById("players"),s=document.getElementById("player-count"),o=document.getElementById("btn-start"),i=document.getElementById("gameStatus"),a=document.getElementById("hostControls"),r=document.querySelector(".room-code-display>.badge"),l=document.getElementById("enableTimer"),c=document.getElementById("timerDuration"),d=document.getElementById("timerValue"),m=document.getElementById("resetTimerOnScore"),u=document.getElementById("timerDurationGroup"),g=document.getElementById("resetTimerGroup"),f=document.getElementById("timerPreview"),y=document.getElementById("previewTime"),p=document.getElementById("resetInfo"),b=document.getElementById("input-timer-enabled"),h=document.getElementById("input-timer-duration"),E=document.getElementById("input-reset-timer-on-score"),v=document.getElementById("disbandBtn"),k=document.getElementById("roomSettingsBtn"),B=document.getElementById("copyRoomCodeBtn"),C=n.getAttribute("data-current-user"),I=n.getAttribute("data-host"),x=[],L=C===I,$=io("/room");function w(){let t=r?r.textContent.replace("Room: ","").trim():"";t&&navigator.clipboard.writeText(t).then(()=>{e("Room code copied to clipboard!","success")}).catch(()=>{e("Failed to copy room code","danger")})}function T(e,t={}){let s=document.createElement("div");s.className="player-item",s.setAttribute("data-player",e),t.isCurrentUser&&s.classList.add("current-user");let o="";t.isCurrentUser&&(o+=' <span class="badge bg-primary ms-2">You</span>'),t.isHost&&(o+=' <span class="badge bg-warning text-dark ms-2"><i class="fas fa-crown me-1"></i>Host</span>'),s.innerHTML=`
    <div class="d-flex align-items-center justify-content-between">
        <div class="player-info">
            <i class="fas fa-circle text-success me-2"></i>
            <span class="player-name fw-semibold">${e}</span>
            ${o}
        </div>
            ${L&&!t.isCurrentUser?`
                <button class="btn btn-sm btn-outline-danger kick-btn" data-username="${e}">
                    <i class="fas fa-times"></i>
                </button>
                `:""}
    </div>
`;let i=s.querySelector(".kick-btn");i&&i.addEventListener("click",t=>{t.stopPropagation(),S(e)}),n.appendChild(s)}function _(){let e=x.length;s&&(s.textContent=e),o&&(o.disabled=!(L&&e>=2)),i&&(e>=2?i.innerHTML=L?`
        <div class="alert alert-success d-flex align-items-center">
            <i class="fas fa-check-circle me-2"></i>
            <span>Ready to start! ${e} players connected</span>
        </div>
        `:`
        <div class="alert alert-info d-flex align-items-center">
            <i class="fas fa-info-circle me-2"></i>
            <span>Waiting for host to start the game (${e} players)</span>
        </div>
        `:i.innerHTML=`
        <div class="alert alert-warning d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span>Waiting for more players... (${e}/2 minimum)</span>
        </div>
        `)}function A(){L&&a&&(a.style.display="block")}function H(e){let t=Math.floor(e/60),n=e%60;d&&(t>0?d.textContent=`${t}m ${n}s`:d.textContent=`${n} seconds`),y&&(y.textContent=e),R()}function R(){if(p&&m){let e=m.checked;p.innerHTML=e?'<i class="fas fa-redo me-1 text-success"></i>Timer resets to full duration when player scores.':'<i class="fas fa-clock me-1 text-warning"></i>Timer continues counting down even after scoring.'}}function j(){t&&(t.value=JSON.stringify(x)),b&&l&&(b.value=l.checked),h&&c&&(h.value=c.value),E&&m&&(E.value=m.checked)}function N(){confirm("Are you sure you want to disband this room?")&&$.emit("disband")}function S(e){confirm(`Are you sure you want to kick ${e} from the room?`)&&$.emit("kick_user",e)}function M(){e("Room settings feature coming soon!","info")}function D(e,t){console.log(`Connection status: ${e}`)}$.on("connect",()=>{console.log("Connected to room"),D("Connected","success"),e("Connected to room","success")}),$.on("disconnect",()=>{console.log("Disconnected from room"),D("Disconnected","danger"),e("Connection lost","danger")}),$.on("self_init",e=>{n.innerHTML="",(x=e.players||[]).forEach(e=>{T(e,{isCurrentUser:e===C,isHost:e===I})}),_(),A(),j()}),$.on("self_kicked",()=>{let e=document.getElementsByClassName("room-section");e.length<1||(window.location.href=e[0].getAttribute("data-join-room-url")||"/")}),$.on("user_join",t=>{x.includes(t)||(T(t,{isCurrentUser:t===C,isHost:t===I}),x.push(t),_(),j(),e(`${t} joined the room`,"success"))}),$.on("user_leave",t=>{let n=document.querySelector(`[data-player="${t}"]`);n&&n.remove();let s=x.indexOf(t);s>-1&&x.splice(s,1),_(),j(),e(`${t} left the room`,"warning")}),$.on("user_kicked",t=>{let n=document.querySelector(`[data-player="${t}"]`);n&&n.remove();let s=x.indexOf(t);s>-1&&x.splice(s,1),_(),j(),e(`${t} has been kicked from the room`,"danger")}),$.on("room_not_found",t=>{e("Room not found! Redirecting...","danger"),setTimeout(()=>{let e=document.getElementsByClassName("room-section");e.length<1||(window.location.href=e[0].getAttribute("data-join-room-url")||"/")},2e3)}),$.on("room_disbanded",()=>{e("This room has been disbanded! Redirecting...","danger"),setTimeout(()=>{let e=document.getElementsByClassName("room-section");e.length<1||(window.location.href=e[0].getAttribute("data-join-room-url")||"/")},3e3)}),$.on("game_start",t=>{let n=document.getElementsByClassName("room-section"),s=document.getElementsByClassName("btn");if(t.started){if(n.length<1)return;window.location.href=n[0].getAttribute("data-game-url")||"/";return}for(let o of(e("The game is starting....","success"),s))o.disabled=!0}),r&&r.addEventListener("click",w),document.getElementsByClassName("timer-settings-card").length>0&&(l.addEventListener("change",function(){let e=this.checked;u.style.display=e?"block":"none",g.style.display=e?"block":"none",f.style.display=e?"block":"none",j()}),c.addEventListener("input",function(){let e=Number.parseInt(this.value);H(e),j()}),m.addEventListener("change",()=>{R(),j()})),v&&v.addEventListener("click",()=>{N()}),B&&B.addEventListener("click",w),k&&k.addEventListener("click",()=>{M()}),c&&H(60),j()});